language:
- objective-c
- c++

compiler:
- clang

sudo: false
os: osx

matrix:
  include:
    - osx_image: xcode7.3
      env: CONFIG=Debug
    - osx_image: xcode7.3
      env: CONFIG=Release
    - osx_image: xcode8.3
      env: CONFIG=Debug
    - osx_image: xcode8.3
      env: CONFIG=Release
    - osx_image: xcode9
      env: CONFIG=Debug
    - osx_image: xcode9
      env: CONFIG=Release

script:
- mkdir build
- cd build
- cmake -G Xcode ..
- cmake --build . --config ${CONFIG} | sed 's/-Wl,-.*//g'
- ctest -C ${CONFIG} . -V
- cd ..
- PACKAGE_NAME=`echo $TRAVIS_REPO_SLUG | sed 's/.*\///g'`
- PACKAGE_REV=`echo $TRAVIS_COMMIT | sed -e 's/^[[:alnum:]]\{7\}/&-/g' | sed 's/-.*//'`
- mkdir $PACKAGE_NAME
- if [ -e package-info.json ]; then cp package-info.json $PACKAGE_NAME; fi
- for f in *.md; do [ -e "$f" ] && cp "$f" $PACKAGE_NAME ; done
- if [ -e icon.png ]; then cp icon.png $PACKAGE_NAME; fi
- if [ -e CMakeLists.txt ]; then cp CMakeLists.txt $PACKAGE_NAME; fi
- if [ -d code ]; then cp -r code $PACKAGE_NAME; fi
- if [ -d docs ]; then cp -r docs $PACKAGE_NAME; fi
- if [ -d examples ]; then cp -r examples $PACKAGE_NAME; fi
- if [ -d extensions ]; then cp -r extensions $PACKAGE_NAME; fi
- if [ -d externals ]; then cp -r externals $PACKAGE_NAME; fi
- if [ -d extras ]; then cp -r extras $PACKAGE_NAME; fi
- if [ -d help ]; then cp -r help $PACKAGE_NAME; fi
- if [ -d init ]; then cp -r init $PACKAGE_NAME; fi
- if [ -d java-classes ]; then cp -r java-classes $PACKAGE_NAME; fi
- if [ -d java-doc ]; then cp -r java-doc $PACKAGE_NAME; fi
- if [ -d javascript ]; then cp -r javascript $PACKAGE_NAME; fi
- if [ -d jsui ]; then cp -r jsui $PACKAGE_NAME; fi
- if [ -d media ]; then cp -r media $PACKAGE_NAME; fi
- if [ -d misc ]; then cp -r misc $PACKAGE_NAME; fi
- if [ -d patchers ]; then cp -r patchers $PACKAGE_NAME; fi
- if [ -d support ]; then cp -r support $PACKAGE_NAME; fi
- if [ -d source ]; then cp -r source $PACKAGE_NAME; fi
- if [ -d tests ]; then cp -r tests $PACKAGE_NAME; fi
- if [ -e $PACKAGE_NAME/ReadMe-Public.md ]; then rm -f $PACKAGE_NAME/ReadMe.md; mv $PACKAGE_NAME/ReadMe-Public.md $PACKAGE_NAME/ReadMe.md; fi
- mkdir dist
- CONFIG_LOWERCASE=`echo $CONFIG | tr '[A-Z]' '[a-z]'`
- zip -r dist/$PACKAGE_NAME-mac-$PACKAGE_REV-$CONFIG_LOWERCASE.zip $PACKAGE_NAME

deploy:
  provider: s3
  access_key_id: AKIAJ4NHY5NBHT76DRGA
  secret_access_key:
    secure: "qUgZI5hbLg+F3bLG38O+FX0G1POr38AesId9O2hSPWihe0iK5DMD5UZy69hZrRWLiBRzKYKjIFuj64KQGtJKHzsxJRSGe4dv0CMpkRT6dHt/fR6z6gRX+48IqGjVrSMNTA5nZu8Ge/wLwa/DBrte0E+UvbZb6QnQD9iH+vyp5mPmFU7AP8KWLjkuk6bslWfYbaDWrX+9uzpAqjC9sFzBS1+U9XNl71QzsSWfmbVXqgRrUdp1gNDQqEmsPEAobFK3jSjIjyONz2XjwwM73wIH6fXwCWfG/YL6+BHkkBYmyv56+0P4iPbIrpGw7SNO7mZ3Bmkpuo/22AGHtk4CO90GlaDBfA5mxJSaJDqslcKVLeu9oLxhTbQMK3VfaByu9RbKfDgAeQxgpqbfcRf8O3GJpY1/LUQCDQjOn84U0wUPGAfdKPwUngWtQtTWN1+/OceT49n0BlmM7lkDubaqf6KTaw+dJhSK8A1Ag1HSLx3w+joQfQDqv7Dogb6i4HwMY2oVzSdqVMxSvYQSEF1jo+rc4gMNawxS3OS60i0kJ7llc2Jpl+HYtEiJuOyka1t3Z92AM6drQ4Gw/0oqAljxt38T3a9ArRnSa9O4KO6CfV3s2b/XBdQwrgQPO/U+17kOBKZEyxnsW5Ki/mxpWZspa0oiWamPou/ZNyG2CJtEO63tOIU="
  bucket: cycling74-ci-public
  skip_cleanup: true
  local-dir: dist
  upload-dir: $PACKAGE_NAME
  acl: public_read
  on:
    repo: Cycling74/$PACKAGE_NAME
    all_branches: true
